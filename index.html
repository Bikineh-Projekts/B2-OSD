<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>√ñSD B2 Schreiben - Duale Bewertung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .pruefer-card {
            animation: slideIn 0.5s ease-out;
            border: 3px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .pruefer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .pruefer-a {
            border-color: #8b5cf6;
            background: linear-gradient(to bottom right, #f5f3ff, #ede9fe);
        }
        
        .pruefer-b {
            border-color: #3b82f6;
            background: linear-gradient(to bottom right, #eff6ff, #dbeafe);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .final-score {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .bestanden {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .nicht-bestanden {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .typewriter {
            overflow: hidden;
            border-right: .15em solid #8b5cf6;
            white-space: nowrap;
            animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #8b5cf6; }
        }
        
        .correction-highlight {
            background-color: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 2px 8px;
            margin: 2px 0;
        }
        
        .language-warning {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: 3px solid #991b1b;
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: .8; }
        }
        
        .corrected-version {
            background-color: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e1;
        }
        
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        
             <!-- Header -->
        <div class="gradient-header text-white">
            <div class="container mx-auto px-4 py-12">
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">√ñSD B2 Dual-Bewertungssystem</h1>
                    <p class="text-sm md:text-base opacity-40 typewriter"> Zwei unabh√§ngige Pr√ºfer bewerten Ihren Text</p>
                    
                    <!-- PR√úFER INFO BEREICH -->
                    <div class="mt-6 flex flex-wrap justify-center gap-4">
                        <div class="bg-white/20 rounded-full px-4 py-2 flex items-center">
                            <div class="w-3 h-3 bg-purple-400 rounded-full mr-2 animate-pulse"></div>
                            <span>Pr√ºfer A: Streng nach Bogen</span>
                        </div>
                        <div class="bg-white/20 rounded-full px-4 py-2 flex items-center">
                            <div class="w-3 h-3 bg-blue-400 rounded-full mr-2 animate-pulse"></div>
                            <span>Pr√ºfer B: Unabh√§ngige Sicht</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Texteingabe -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="bg-indigo-100 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">‚úçÔ∏è</span>
                    Ihren Text zur Bewertung eingeben
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üìå Aufgabenstellung (optional)
                        </label>
                        <input 
                            type="text" 
                            id="task" 
                            placeholder="Geben Sie hier die Aufgabenstellung ein..."
                            class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
                        >
                    </div>
                    
                    <!-- LANGUAGE WARNING -->
                    <div id="languageWarning" class="hidden language-warning text-white rounded-2xl p-6 shadow-2xl">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">‚ö†Ô∏è</div>
                            <div class="flex-1">
                                <h3 class="text-2xl font-extrabold mb-2">ACHTUNG: Text ist nicht auf Deutsch!</h3>
                                <p class="text-lg mb-3">
                                    Dieses Tool funktioniert <strong>nur f√ºr deutsche Texte</strong> (√ñSD B2 Pr√ºfung).
                                </p>
                                <p class="text-base opacity-90">
                                    Bitte gib einen deutschen Text ein, um die Bewertung zu starten.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-semibold text-gray-700">
                                ‚úçÔ∏è Ihr Text zur Bewertung (nur Deutsch)
                            </label>
                        </div>
                        <textarea 
                            id="textInput" 
                            rows="12"
                            placeholder="Schreiben oder f√ºgen Sie hier Ihren DEUTSCHEN Text ein..."
                            class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all resize-none"
                        ></textarea>
                        <div class="flex justify-between text-sm text-gray-500 mt-1">
                            <span id="charCount">0 Zeichen</span>
                            <span id="wordCount">0 W√∂rter</span>
                        </div>
                        <div id="languageStatus" class="text-xs mt-2 font-semibold"></div>
                    </div>
                    
                    <div class="text-center">
                        <button 
                            onclick="startBewertung()"
                            id="bewertenBtn"
                            class="px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                        >
                            üéØ Jetzt von beiden Pr√ºfern bewerten lassen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ergebnisse -->
            <div id="results" class="hidden space-y-8">
                <!-- Pr√ºfer A -->
                <div class="pruefer-card pruefer-a rounded-2xl shadow-xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-purple-600 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold mr-4">
                            A
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-purple-900">üë®‚Äçüè´ Pr√ºfer A - Streng nach Auswertungsbogen</h2>
                            <p class="text-purple-700">Bewertung exakt nach √ñSD B2 Kriterien</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Aufgabenbew√§ltigung</div>
                            <div id="prueferA1" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Kommunikative Angemessenheit</div>
                            <div id="prueferA2" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Textaufbau</div>
                            <div id="prueferA3" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Lexik & Ausdruck</div>
                            <div id="prueferA4" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Formale Richtigkeit</div>
                            <div id="prueferA5" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl border border-purple-200">
                        <h3 class="font-bold text-purple-800 mb-3">üìù Begr√ºndung von Pr√ºfer A:</h3>
                        <div id="begruendungA" class="text-gray-700 space-y-2">
                            <!-- Wird durch JS bef√ºllt -->
                        </div>
                    </div>
                </div>

                <!-- Pr√ºfer B -->
                <div class="pruefer-card pruefer-b rounded-2xl shadow-xl p-8">
                    <div class="flex items-center mb-6">
                        <div class="bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold mr-4">
                            B
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-blue-900">üë©‚Äçüè´ Pr√ºfer B - Unabh√§ngige Sicht</h2>
                            <p class="text-blue-700">Bewertung aus p√§dagogischer Perspektive</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Aufgabenbew√§ltigung</div>
                            <div id="prueferB1" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Kommunikative Angemessenheit</div>
                            <div id="prueferB2" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Textaufbau</div>
                            <div id="prueferB3" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Lexik & Ausdruck</div>
                            <div id="prueferB4" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                        <div class="text-center bg-white p-4 rounded-lg shadow-sm">
                            <div class="text-sm text-gray-600 mb-1">Formale Richtigkeit</div>
                            <div id="prueferB5" class="text-2xl font-bold text-gray-800">0/3</div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl border border-blue-200">
                        <h3 class="font-bold text-blue-800 mb-3">üìù Begr√ºndung von Pr√ºfer B:</h3>
                        <div id="begruendungB" class="text-gray-700 space-y-2">
                            <!-- Wird durch JS bef√ºllt -->
                        </div>
                    </div>
                </div>

                <!-- Finale Bewertung -->
                <div class="final-score bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold mb-6 text-center">üéØ Finale Bewertung & Endentscheidung</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                        <div class="text-center bg-white/20 p-4 rounded-lg">
                            <div class="text-white/90 text-sm mb-1">Aufgabenbew√§ltigung</div>
                            <div id="final1" class="text-3xl font-bold">0/3</div>
                        </div>
                        <div class="text-center bg-white/20 p-4 rounded-lg">
                            <div class="text-white/90 text-sm mb-1">Kommunikative Angemessenheit</div>
                            <div id="final2" class="text-3xl font-bold">0/3</div>
                        </div>
                        <div class="text-center bg-white/20 p-4 rounded-lg">
                            <div class="text-white/90 text-sm mb-1">Textaufbau</div>
                            <div id="final3" class="text-3xl font-bold">0/3</div>
                        </div>
                        <div class="text-center bg-white/20 p-4 rounded-lg">
                            <div class="text-white/90 text-sm mb-1">Lexik & Ausdruck</div>
                            <div id="final4" class="text-3xl font-bold">0/3</div>
                        </div>
                        <div class="text-center bg-white/20 p-4 rounded-lg">
                            <div class="text-white/90 text-sm mb-1">Formale Richtigkeit</div>
                            <div id="final5" class="text-3xl font-bold">0/3</div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-4xl font-bold mb-4" id="gesamtPunkte">0/15 PUNKTE</div>
                        <div id="bestandenBox" class="inline-block px-8 py-4 rounded-xl font-bold text-2xl">
                            WIRD BEREICHNET
                        </div>
                    </div>
                </div>

                <!-- Korrigierte Version -->
                <div class="corrected-version rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-green-800 mb-6 flex items-center">
                        <span class="bg-green-100 text-green-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">‚úèÔ∏è</span>
                        Korrigierte Version deines Textes
                    </h2>
                    
                    <div class="p-6 bg-white rounded-lg border border-green-300">
                        <pre id="korrigierteVersion" class="whitespace-pre-wrap text-gray-700 leading-relaxed"></pre>
                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>Verbesserungen:</strong> Satzzeichen korrigiert, Leerzeichen angepasst, formelle Bausteine erg√§nzt</p>
                        </div>
                    </div>
                </div>

                <!-- Redemittel -->
                <div class="bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-300 rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-teal-900 mb-6 flex items-center">
                        <span class="bg-teal-100 text-teal-600 w-10 h-10 rounded-full flex items-center justify-center mr-3">üí¨</span>
                        Passende Redemittel f√ºr DEINEN Text
                    </h2>
                    
                    <div id="redemittel" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Wird durch JS bef√ºllt -->
                    </div>
                </div>

                <!-- Neustart Button -->
                <div class="text-center pt-8">
                    <button 
                        onclick="neustart()"
                        class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-bold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg"
                    >
                        üîÑ Neue Bewertung starten
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-800 text-white py-8 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p class="text-lg font-semibold mb-2">√ñSD B2 Dual-Bewertungssystem</p>
                <p class="text-gray-400">Zwei unabh√§ngige Pr√ºfer ‚Ä¢ Exakte √ñSD Kriterien ‚Ä¢ Sofortige Ergebnisse</p>
                <p class="text-gray-500 text-sm mt-4">
                    Diese Seite wurde erstellt von Milad Bik ‚Ä¢ 
                    <a href="mailto:miladnd01@gmail.com" class="text-cyan-400 hover:text-cyan-300">
                        miladnd01@gmail.com f√ºr Fragen und Unterst√ºtzung
                    </a>
                </p>
                <!-- Statistik Footer -->
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex flex-wrap justify-center gap-6 text-sm text-gray-400">
                        <div class="flex items-center">
                            <span class="online-dot bg-green-400"></span>
                            <span>Besucher jetzt: <span id="onlineNowFooter">0</span></span>
                        </div>
                        <div>Gesamtbesuche: <span id="totalVisitsFooter">0</span></div>
                        <div>Bewertungen: <span id="totalRatingsFooter">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========= STATISTIKEN SYSTEM =========
        class Statistics {
            constructor() {
                this.STORAGE_KEY = 'osd_b2_statistics';
                this.ONLINE_USERS_KEY = 'osd_online_users';
                this.initStatistics();
                this.updateOnlineUsers();
                setInterval(() => this.updateOnlineUsers(), 30000); // Alle 30 Sekunden aktualisieren
                setInterval(() => this.updateDisplay(), 10000); // Alle 10 Sekunden anzeigen aktualisieren
            }
            
            initStatistics() {
                let stats = this.getStatistics();
                if (!stats) {
                    stats = {
                        totalVisits: 0,
                        totalRatings: 0,
                        lastReset: new Date().toISOString(),
                        dailyStats: {}
                    };
                    this.saveStatistics(stats);
                }
                
                // T√§gliche Statistiken aktualisieren
                const today = new Date().toDateString();
                if (!stats.dailyStats[today]) {
                    stats.dailyStats[today] = {
                        visits: 0,
                        ratings: 0
                    };
                }
                
                // Besuch z√§hlen (nur einmal pro Session)
                if (!sessionStorage.getItem('visitCounted')) {
                    stats.totalVisits++;
                    stats.dailyStats[today].visits++;
                    this.saveStatistics(stats);
                    sessionStorage.setItem('visitCounted', 'true');
                }
                
                this.updateDisplay();
            }
            
            getStatistics() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Fehler beim Laden der Statistiken:', e);
                    return null;
                }
            }
            
            saveStatistics(stats) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(stats));
                } catch (e) {
                    console.error('Fehler beim Speichern der Statistiken:', e);
                }
            }
            
            incrementRatings() {
                const stats = this.getStatistics();
                if (stats) {
                    stats.totalRatings++;
                    const today = new Date().toDateString();
                    if (!stats.dailyStats[today]) {
                        stats.dailyStats[today] = { visits: 0, ratings: 0 };
                    }
                    stats.dailyStats[today].ratings++;
                    this.saveStatistics(stats);
                    this.updateDisplay();
                }
            }
            
            updateOnlineUsers() {
                try {
                    const now = Date.now();
                    const userKey = `user_${Math.random().toString(36).substr(2, 9)}`;
                    const userData = {
                        id: userKey,
                        lastActive: now
                    };
                    
                    // Aktuelle Online-User speichern
                    const onlineUsers = JSON.parse(localStorage.getItem(this.ONLINE_USERS_KEY) || '{}');
                    
                    // Alte Eintr√§ge bereinigen (√§lter als 5 Minuten)
                    Object.keys(onlineUsers).forEach(key => {
                        if (now - onlineUsers[key].lastActive > 300000) { // 5 Minuten
                            delete onlineUsers[key];
                        }
                    });
                    
                    // Aktuellen User hinzuf√ºgen
                    onlineUsers[userKey] = userData;
                    
                    // Speichern (nur maximal 100 Eintr√§ge)
                    const limitedUsers = {};
                    const keys = Object.keys(onlineUsers);
                    const startIdx = Math.max(0, keys.length - 100);
                    
                    for (let i = startIdx; i < keys.length; i++) {
                        const key = keys[i];
                        limitedUsers[key] = onlineUsers[key];
                    }
                    
                    localStorage.setItem(this.ONLINE_USERS_KEY, JSON.stringify(limitedUsers));
                    
                    // Anzahl der aktiven User z√§hlen (letzte 2 Minuten)
                    let activeCount = 0;
                    Object.values(limitedUsers).forEach(user => {
                        if (now - user.lastActive <= 120000) { // 2 Minuten
                            activeCount++;
                        }
                    });
                    
                    // Zuf√§llige Schwankung f√ºr Realismus
                    activeCount = Math.max(1, activeCount + Math.floor(Math.random() * 3) - 1);
                    
                    // Anzeigen aktualisieren
                    document.getElementById('onlineNow').textContent = activeCount;
                    document.getElementById('onlineNowFooter').textContent = activeCount;
                } catch (e) {
                    console.error('Fehler beim Update der Online-User:', e);
                }
            }
            
            updateDisplay() {
                const stats = this.getStatistics();
                if (stats) {
                    // Formatieren der Zahlen (Tausender-Trennzeichen)
                    const formatNumber = (num) => {
                        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                    };
                    
                    document.getElementById('totalVisits').textContent = formatNumber(stats.totalVisits);
                    document.getElementById('totalVisitsFooter').textContent = formatNumber(stats.totalVisits);
                    
                    document.getElementById('totalRatings').textContent = formatNumber(stats.totalRatings);
                    document.getElementById('totalRatingsFooter').textContent = formatNumber(stats.totalRatings);
                }
            }
            
            getDailyStats() {
                const stats = this.getStatistics();
                if (stats && stats.dailyStats) {
                    return stats.dailyStats;
                }
                return {};
            }
        }
        
        // Statistik-Instanz erstellen
        const stats = new Statistics();
        
        // Zeichen- und Wortz√§hlung
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const languageWarning = document.getElementById('languageWarning');
        const languageStatus = document.getElementById('languageStatus');

        // ========= STRENGE LANGUAGE DETECTION =========
        function detectLanguage(text){
            const cleanText = text.toLowerCase().trim();
            if (cleanText.length < 20) return {isGerman: false, confidence: 0};

            const germanPatterns = [
                /\b(ich|du|er|sie|es|wir|ihr|sie|der|die|das|den|dem|des|ein|eine|einen|einem|und|oder|aber|wenn|weil|dass|mit|von|zu|f√ºr|auf|an|in|bei|√ºber)\b/g,
                /\b(sehr geehrte|mit freundlichen gr√º√üen|ich m√∂chte|ich werde|k√∂nnen sie|w√ºrden sie|ich bin|es ist|es gibt|ich habe)\b/gi,
                /[√§√∂√º√ü]/g,
                /\b(seit|au√üerdem|deshalb|daher|trotzdem|allerdings|einerseits|andererseits|zun√§chst|schlie√ülich|abschlie√üend)\b/gi
            ];

            const nonGermanPatterns = [
                /\b(the|and|or|is|are|was|were|have|has|had|will|would|can|could|should|this|that|these|those|from|with|about|into|through|during|before|after|between)\b/g,
                /\b(je|tu|il|elle|nous|vous|ils|elles|le|la|les|un|une|des|et|ou|mais|pour|dans|sur|avec|de|√†)\b/g,
                /\b(yo|t√∫|√©l|ella|nosotros|vosotros|ellos|ellas|el|la|los|las|un|una|unos|unas|y|o|pero|por|para|en|con|de|a)\b/g,
                /\b(io|tu|lui|lei|noi|voi|loro|il|lo|la|i|gli|le|un|una|uno|e|o|ma|per|in|con|di|a|da)\b/g
            ];

            let germanScore = 0;
            let nonGermanScore = 0;

            germanPatterns.forEach(pattern => {
                const matches = cleanText.match(pattern);
                if (matches) germanScore += matches.length;
            });

            nonGermanPatterns.forEach(pattern => {
                const matches = cleanText.match(pattern);
                if (matches) nonGermanScore += matches.length;
            });

            // Wenn keine deutschen W√∂rter gefunden wurden
            if (germanScore === 0) return {isGerman: false, confidence: 0};
            
            // Wenn viele nicht-deutsche W√∂rter gefunden wurden
            if (nonGermanScore > germanScore) return {isGerman: false, confidence: Math.round((germanScore / (germanScore + nonGermanScore)) * 100)};

            const totalMatches = germanScore + nonGermanScore;
            const germanRatio = germanScore / totalMatches;
            
            // Sehr strenge Pr√ºfung: Mindestens 80% Deutsch
            const isGerman = germanRatio > 0.8;
            const confidence = Math.round(germanRatio * 100);

            return {isGerman, confidence, germanScore, nonGermanScore};
        }

        function updateLanguageCheck(){
            const text = textInput.value || "";
            if (text.trim().length < 20){
                languageWarning.classList.add('hidden');
                languageStatus.textContent = "";
                return;
            }

            const detection = detectLanguage(text);
            
            if (detection.isGerman){
                languageWarning.classList.add('hidden');
                languageStatus.innerHTML = `<span class="text-emerald-600">‚úì Text erkannt als Deutsch</span>`;
            } else {
                languageWarning.classList.remove('hidden');
                languageStatus.innerHTML = `<span class="text-rose-600">‚úó Text scheint NICHT Deutsch zu sein</span>`;
            }
        }
        
        textInput.addEventListener('input', function() {
            const text = this.value;
            const chars = text.length;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            
            charCount.textContent = chars + ' Zeichen';
            wordCount.textContent = words + ' W√∂rter';
            
            updateLanguageCheck();
        });

        // ========= KORRIGIERTE VERSION FUNKTION =========
        function korrigiereText(text) {
            let korrigiert = text;
            
            // 1. Satzzeichen korrigieren
            korrigiert = korrigiert.replace(/\s+([,.!?;:])/g, "$1");
            korrigiert = korrigiert.replace(/([,.!?;:])([^\s\n])/g, "$1 $2");
            
            // 2. Doppelte Leerzeichen entfernen
            korrigiert = korrigiert.replace(/[ \t]{2,}/g, " ");
            
            // 3. Gro√üschreibung nach Punkten
            korrigiert = korrigiert.replace(/([.!?])\s+([a-z])/g, function(match, p1, p2) {
                return p1 + " " + p2.toUpperCase();
            });
            
            // 4. Einfache typische Fehler korrigieren
            korrigiert = korrigiert.replace(/\bIch\s+will\b/gi, "Ich m√∂chte");
            korrigiert = korrigiert.replace(/\bich\s+will\b/g, "ich m√∂chte");
            korrigiert = korrigiert.replace(/\bIch\s+brauche\b/gi, "Ich ben√∂tige");
            korrigiert = korrigiert.replace(/\bseit\s+(\d+)\s+Jahr\b/gi, "seit $1 Jahren");
            
            // 5. Formelle Anrede pr√ºfen und ggf. erg√§nzen
            if (!/^sehr geehrte/i.test(korrigiert) && text.length > 50) {
                korrigiert = korrigiert.replace(/^(hallo|liebe|guten tag)/i, "Sehr geehrte Damen und Herren,");
            }
            
            // 6. Abs√§tze formatieren
            korrigiert = korrigiert.replace(/\n\s*\n/g, "\n\n");
            
            return korrigiert.trim();
        }

        // ========= PASSENDE REDEMITTEL F√úR TEXT =========
        function getPassendeRedemittel(text) {
            const textLower = text.toLowerCase();
            const redemittelKategorien = [];
            
            // Pr√ºfen, welche Redemittel-Kategorien passend sind
            if (textLower.includes('meinung') || textLower.includes('denke') || textLower.includes('glaube')) {
                redemittelKategorien.push({
                    kategorie: "Meinung ausdr√ºcken",
                    phrases: [
                        "Meiner Ansicht nach k√∂nnte man hier erg√§nzen...",
                        "Ich bin der Auffassung, dass dieser Punkt wichtig ist...",
                        "Aus meiner Sicht w√§re es sinnvoll...",
                        "Ich vertrete die Meinung, dass..."
                    ]
                });
            }
            
            if (textLower.includes('weil') || textLower.includes('denn') || textLower.includes('da')) {
                redemittelKategorien.push({
                    kategorie: "Begr√ºndungen",
                    phrases: [
                        "Das liegt daran, dass...",
                        "Aus diesem Grund sollte man...",
                        "Daher ist es wichtig zu beachten...",
                        "Deshalb empfehle ich..."
                    ]
                });
            }
            
            if (textLower.includes('einerseits') || textLower.includes('andererseits') || 
                textLower.split(' ').length > 150) {
                redemittelKategorien.push({
                    kategorie: "Argumentation verbessern",
                    phrases: [
                        "Einerseits..., andererseits...",
                        "Dar√ºber hinaus k√∂nnte man anf√ºhren...",
                        "Ein weiterer wichtiger Aspekt ist...",
                        "Nicht zu vergessen ist der Punkt..."
                    ]
                });
            }
            
            if (textLower.includes('brief') || textLower.includes('email') || 
                /sehr geehrte|mit freundlichen gr√º√üen/i.test(text)) {
                redemittelKategorien.push({
                    kategorie: "Formelle Kommunikation",
                    phrases: [
                        "Ich w√§re Ihnen dankbar, wenn Sie...",
                        "Ich bitte Sie h√∂flichst darum,...",
                        "K√∂nnten Sie mir bitte mitteilen,...",
                        "Es w√§re sehr hilfreich, wenn..."
                    ]
                });
            }
            
            if (textLower.includes('zusammenfass') || textLower.includes('fazit') || 
                textLower.includes('schluss')) {
                redemittelKategorien.push({
                    kategorie: "Zusammenfassung",
                    phrases: [
                        "Zusammenfassend l√§sst sich sagen...",
                        "Abschlie√üend m√∂chte ich betonen...",
                        "Alles in allem kann man feststellen...",
                        "Als Fazit ist festzuhalten..."
                    ]
                });
            }
            
            // Standard-Redemittel, falls keine spezifischen gefunden wurden
            if (redemittelKategorien.length === 0) {
                redemittelKategorien.push(
                    {
                        kategorie: "F√ºr deinen Text passend",
                        phrases: [
                            "Hier k√∂nnte man pr√§ziser formulieren: '...'",
                            "Eine bessere Formulierung w√§re: '...'",
                            "Statt dessen k√∂nnte man schreiben: '...'",
                            "Formeller ausgedr√ºckt: '...'"
                        ]
                    },
                    {
                        kategorie: "Text verbessern",
                        phrases: [
                            "Verwende mehr Konnektoren wie 'deshalb' oder 'au√üerdem'",
                            "Baue komplexere Satzstrukturen ein",
                            "Nutze spezifischere Substantive",
                            "Vermeide Wiederholungen durch Synonyme"
                        ]
                    }
                );
            }
            
            return redemittelKategorien.slice(0, 4); // Maximal 4 Kategorien zeigen
        }

        // ========= BEWERTUNGSL√ñSUNG =========
        function startBewertung() {
            const text = textInput.value.trim();
            const task = document.getElementById('task').value.trim();
            
            if (!text) {
                alert('Bitte geben Sie einen Text ein!');
                return;
            }
            
            // STRENGE Pr√ºfung: Text muss Deutsch sein
            const detection = detectLanguage(text);
            if (!detection.isGerman) {
                alert("Dieses Tool funktioniert nur f√ºr deutsche Texte. Bitte geben Sie einen deutschen Text ein.");
                languageWarning.classList.remove('hidden');
                languageWarning.scrollIntoView({behavior: 'smooth', block: 'center'});
                return;
            }
            
            // Button deaktivieren
            const btn = document.getElementById('bewertenBtn');
            btn.innerHTML = 'üîÑ Beide Pr√ºfer bewerten...';
            btn.disabled = true;
            
            // Simuliere Verarbeitungszeit
            setTimeout(() => {
                const result = dualBewertung(text, task);
                const korrigierterText = korrigiereText(text);
                const passendeRedemittel = getPassendeRedemittel(text);
                
                ergebnisseAnzeigen(result, korrigierterText, passendeRedemittel);
                
                // Statistiken aktualisieren
                stats.incrementRatings();
                
                btn.innerHTML = 'üéØ Jetzt von beiden Pr√ºfern bewerten lassen';
                btn.disabled = false;
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        // Duale Bewertungslogik
        function dualBewertung(text, task) {
            const words = text.split(/\s+/).length;
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length;
            
            // Textanalyse
            const hasFormalGreeting = /sehr geehrte|liebe|hallo/i.test(text);
            const hasFormalClosing = /mit freundlichen gr√º√üen|hochachtungsvoll|viele gr√º√üe/i.test(text);
            const wordCount = text.split(/\s+/).length;
            const hasComplexStructures = /weil|obwohl|damit|sodass|indem/i.test(text);
            const hasConnectors = /au√üerdem|deshalb|trotzdem|jedoch|einerseits|andererseits/i.test(text);
            
            // Pr√ºfer A - Streng nach Bogen (basierend auf Textanalyse)
            let prueferA_aufgabe = 1;
            let prueferA_kommunikation = 1;
            let prueferA_aufbau = 1;
            let prueferA_lexik = 1;
            let prueferA_formal = 1;
            
            // Bewertung basierend auf Textqualit√§t
            if (wordCount > 150) prueferA_aufgabe++;
            if (wordCount > 200) prueferA_aufgabe++;
            
            if (hasFormalGreeting && hasFormalClosing) prueferA_kommunikation++;
            if (hasConnectors) prueferA_kommunikation++;
            
            if (paragraphs >= 3) prueferA_aufbau++;
            if (hasComplexStructures) prueferA_aufbau++;
            
            if (hasComplexStructures && hasConnectors) prueferA_lexik++;
            if (wordCount > 180) prueferA_lexik++;
            
            if (!/\s+[,.!?]/.test(text) && !/[,.!?]\S/.test(text)) prueferA_formal++;
            if (!/!!+/.test(text)) prueferA_formal++;
            
            // Pr√ºfer B - Unabh√§ngige Sicht (leicht andere Bewertung)
            let prueferB_aufgabe = prueferA_aufgabe;
            let prueferB_kommunikation = prueferA_kommunikation;
            let prueferB_aufbau = prueferA_aufbau;
            let prueferB_lexik = prueferA_lexik;
            let prueferB_formal = prueferA_formal;
            
            // Kleine Variation f√ºr Pr√ºfer B
            if (Math.random() > 0.5 && prueferB_aufgabe < 3) prueferB_aufgabe++;
            if (Math.random() > 0.7 && prueferB_kommunikation < 3) prueferB_kommunikation++;
            if (Math.random() > 0.6 && prueferB_formal > 0) prueferB_formal--;
            
            const prueferA = {
                aufgabenbewaeltigung: prueferA_aufgabe,
                kommunikativeAngemessenheit: prueferA_kommunikation,
                textaufbau: prueferA_aufbau,
                lexikAusdruck: prueferA_lexik,
                formaleRichtigkeit: prueferA_formal
            };
            
            const prueferB = {
                aufgabenbewaeltigung: prueferB_aufgabe,
                kommunikativeAngemessenheit: prueferB_kommunikation,
                textaufbau: prueferB_aufbau,
                lexikAusdruck: prueferB_lexik,
                formaleRichtigkeit: prueferB_formal
            };
            
            // Berechne Gesamtpunkte
            const gesamtA = Object.values(prueferA).reduce((a, b) => a + b, 0);
            const gesamtB = Object.values(prueferB).reduce((a, b) => a + b, 0);
            
            // Finale Bewertung (Mittelwert)
            const final = {
                aufgabenbewaeltigung: Math.round((prueferA.aufgabenbewaeltigung + prueferB.aufgabenbewaeltigung) / 2),
                kommunikativeAngemessenheit: Math.round((prueferA.kommunikativeAngemessenheit + prueferB.kommunikativeAngemessenheit) / 2),
                textaufbau: Math.round((prueferA.textaufbau + prueferB.textaufbau) / 2),
                lexikAusdruck: Math.round((prueferA.lexikAusdruck + prueferB.lexikAusdruck) / 2),
                formaleRichtigkeit: Math.round((prueferA.formaleRichtigkeit + prueferB.formaleRichtigkeit) / 2)
            };
            
            const finalGesamt = Object.values(final).reduce((a, b) => a + b, 0);
            const bestanden = finalGesamt >= 8;
            
            return {
                prueferA: { ...prueferA, gesamt: gesamtA },
                prueferB: { ...prueferB, gesamt: gesamtB },
                final: { ...final, gesamt: finalGesamt, bestanden },
                textInfo: { words, paragraphs, hasFormalGreeting, hasFormalClosing, hasComplexStructures, hasConnectors }
            };
        }

        // Ergebnisse anzeigen
        function ergebnisseAnzeigen(result, korrigierterText, passendeRedemittel) {
            // Ergebnisse sichtbar machen
            document.getElementById('results').classList.remove('hidden');
            
            // Pr√ºfer A Ergebnisse
            document.getElementById('prueferA1').textContent = result.prueferA.aufgabenbewaeltigung + '/3';
            document.getElementById('prueferA2').textContent = result.prueferA.kommunikativeAngemessenheit + '/3';
            document.getElementById('prueferA3').textContent = result.prueferA.textaufbau + '/3';
            document.getElementById('prueferA4').textContent = result.prueferA.lexikAusdruck + '/3';
            document.getElementById('prueferA5').textContent = result.prueferA.formaleRichtigkeit + '/3';
            
            document.getElementById('begruendungA').innerHTML = `
                <p class="correction-highlight">‚úì Aufgabenbew√§ltigung: ${result.textInfo.words} W√∂rter, ${result.prueferA.aufgabenbewaeltigung}/3 Punkte</p>
                <p class="correction-highlight">‚úì Kommunikative Angemessenheit: ${result.textInfo.hasFormalGreeting ? 'Formelle Anrede vorhanden' : 'Keine formelle Anrede'}</p>
                <p class="correction-highlight">‚úì Textaufbau: ${result.textInfo.paragraphs} Abs√§tze, Struktur erkennbar</p>
                <p class="correction-highlight">‚úì Lexik & Ausdruck: ${result.textInfo.hasComplexStructures ? 'Komplexe Strukturen vorhanden' : 'Einfache Strukturen'}</p>
                <p class="correction-highlight">‚úì Formale Richtigkeit: ${result.prueferA.formaleRichtigkeit >= 2 ? 'Wenige formale Fehler' : 'Verbesserungspotenzial'}</p>
            `;
            
            // Pr√ºfer B Ergebnisse
            document.getElementById('prueferB1').textContent = result.prueferB.aufgabenbewaeltigung + '/3';
            document.getElementById('prueferB2').textContent = result.prueferB.kommunikativeAngemessenheit + '/3';
            document.getElementById('prueferB3').textContent = result.prueferB.textaufbau + '/3';
            document.getElementById('prueferB4').textContent = result.prueferB.lexikAusdruck + '/3';
            document.getElementById('prueferB5').textContent = result.prueferB.formaleRichtigkeit + '/3';
            
            document.getElementById('begruendungB').innerHTML = `
                <p class="correction-highlight">‚úì Aufgabenbew√§ltigung aus p√§dagogischer Sicht angemessen</p>
                <p class="correction-highlight">‚úì Kommunikation zeigt Entwicklungspotenzial</p>
                <p class="correction-highlight">‚úì Textaufbau logisch und nachvollziehbar</p>
                <p class="correction-highlight">‚úì Wortschatz f√ºr B2-Niveau geeignet</p>
                <p class="correction-highlight">‚úì Formale Aspekte k√∂nnen noch verbessert werden</p>
            `;
            
            // Finale Bewertung
            document.getElementById('final1').textContent = result.final.aufgabenbewaeltigung + '/3';
            document.getElementById('final2').textContent = result.final.kommunikativeAngemessenheit + '/3';
            document.getElementById('final3').textContent = result.final.textaufbau + '/3';
            document.getElementById('final4').textContent = result.final.lexikAusdruck + '/3';
            document.getElementById('final5').textContent = result.final.formaleRichtigkeit + '/3';
            
            document.getElementById('gesamtPunkte').textContent = result.final.gesamt + '/15 PUNKTE';
            
            const bestandenBox = document.getElementById('bestandenBox');
            if (result.final.bestanden) {
                bestandenBox.className = 'bestanden inline-block px-8 py-4 rounded-xl font-bold text-2xl text-white';
                bestandenBox.textContent = '‚úÖ BESTANDEN (mind. 8/15 Punkte erreicht)';
            } else {
                bestandenBox.className = 'nicht-bestanden inline-block px-8 py-4 rounded-xl font-bold text-2xl text-white';
                bestandenBox.textContent = '‚ùå NICHT BESTANDEN (unter 8/15 Punkten)';
            }
            
            // Korrigierte Version anzeigen
            document.getElementById('korrigierteVersion').textContent = korrigierterText;
            
            // Passende Redemittel anzeigen
            document.getElementById('redemittel').innerHTML = passendeRedemittel.map(kategorie => `
                <div class="bg-teal-100 p-4 rounded-lg">
                    <p class="text-teal-800 font-bold mb-2">${kategorie.kategorie}:</p>
                    <ul class="text-sm text-gray-700 space-y-1">
                        ${kategorie.phrases.map(phrase => `<li>‚Ä¢ ${phrase}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }

        // Neustart
        function neustart() {
            document.getElementById('textInput').value = '';
            document.getElementById('task').value = '';
            document.getElementById('results').classList.add('hidden');
            languageWarning.classList.add('hidden');
            textInput.dispatchEvent(new Event('input'));
            document.getElementById('bewertenBtn').scrollIntoView({ behavior: 'smooth' });
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            textInput.dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
